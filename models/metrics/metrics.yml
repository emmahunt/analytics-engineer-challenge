
version: 2

metrics:
  - name: new_users
    label: New Users
    model: ref('dim_user')
    description: "The count of new users - people or organisations who have created an account and submitted payment details for the product."

    calculation_method: count_distinct
    expression: user_id 

    timestamp: created_at
    time_grains: [day, week, month, quarter, year]

    dimensions:
      - user_cohort_week

  - name: lapsed_users
    label: Lapsed Users
    model: ref('dim_user')
    description: "A user is considered lapsed if they have not generated a page view in 7 days."

    calculation_method: count_distinct
    expression: user_identifier

    timestamp: lapsed_date
    time_grains: [day, week, month, quarter, year]

    dimensions:
      - user_identifier
      - user_cohort_week

models:
  - name: user_retention
    description: "This model calculates some user retention metrics such as active_users, lapsed_users and retention rate, at a weekly grain and broken down by weekly user sign up cohorts. It is at the grain of one row per week, per user cohort."
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - date_week
            - user_cohort_week
    columns:
      - name: date_week
        description: "The date of the start of a week: this is the period for which the metrics will be calculated."
      - name: user_cohort_week
        description: "The date of the start of the week in which the user was created"
      - name: new_users
        description: "Number of new users that were created in the date_week period, in the given cohort group."
      - name: lapsed_users
        description: "Number of lapsed users that lapsed in the date_week period, in the given cohort group."
      - name: active_users
        description: "The number of active users (had a page view) in the date_week period, in the given cohort group."
      - name: retained_users
        description: "Number of non-lapsed users in the date_week period, in the given cohort group."
      - name: retention_rate
        description: "The proportion of active users in the given date week period that did not lapse."
  